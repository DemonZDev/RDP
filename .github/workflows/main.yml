name: Ubuntu KDE RDP

on:
  workflow_dispatch:

jobs:
  ubuntu-kde-rdp:
    runs-on: ubuntu-24.04  # or: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Update apt & install KDE Plasma + XRDP
        run: |
          set -eux

          sudo DEBIAN_FRONTEND=noninteractive apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            kde-plasma-desktop xrdp xorg dbus-x11

          # Small XRDP tweak (avoids cursor issues on some setups)
          if grep -q '^new_cursors=true' /etc/xrdp/xrdp.ini; then
            sudo sed -i 's/^new_cursors=true/new_cursors=false/' /etc/xrdp/xrdp.ini
          fi

          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

      - name: Create RDP user with random password
        run: |
          set -eux

          USERNAME="rdp"

          if ! id "$USERNAME" >/dev/null 2>&1; then
            sudo useradd -m -s /bin/bash "$USERNAME"
          fi

          PASSWORD=$(tr -dc 'A-Za-z0-9@#%+=_:./-' < /dev/urandom | head -c 20)
          echo "$USERNAME:$PASSWORD" | sudo chpasswd

          sudo usermod -aG sudo "$USERNAME"
          sudo usermod -aG ssl-cert "$USERNAME" || true

          echo "RDP_USER=$USERNAME" >> "$GITHUB_ENV"
          echo "RDP_PASSWORD=$PASSWORD" >> "$GITHUB_ENV"

      - name: Configure KDE Plasma session for XRDP
        run: |
          set -eux

          USERNAME="$RDP_USER"

          # Set up KDE Plasma session for xrdp for that user
          sudo -u "$USERNAME" bash -lc '
            echo "startplasma-x11" > ~/.xsession

            D=/usr/share/plasma:/usr/local/share:/usr/share:/var/lib/snapd/desktop
            C=/etc/xdg/xdg-plasma:/etc/xdg
            C=${C}:/usr/share/kubuntu-default-settings/kf5-settings

            cat > ~/.xsessionrc <<EOF
export XDG_SESSION_DESKTOP=KDE
export XDG_DATA_DIRS=${D}
export XDG_CONFIG_DIRS=${C}
EOF
          '

          sudo systemctl restart xrdp

      - name: Install Tailscale
        run: |
          set -eux

          curl -fsSL https://tailscale.com/install.sh | sudo sh
          sudo systemctl enable --now tailscaled

      - name: Bring Tailscale up
        env:
          TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          set -eux

          if [ -z "$TS_AUTHKEY" ]; then
            echo "Missing TAILSCALE_AUTH_KEY in repo secrets" >&2
            exit 1
          fi

          sudo tailscale up \
            --authkey="${TS_AUTHKEY}" \
            --hostname="gh-ubuntu-kde-${GITHUB_RUN_ID}" \
            --reset

          TS_IP=$(tailscale ip -4 | head -n 1 || true)

          if [ -z "$TS_IP" ]; then
            echo "No Tailscale IPv4 address, exiting." >&2
            exit 1
          fi

          echo "TAILSCALE_IP=$TS_IP" >> "$GITHUB_ENV"
          echo "Tailscale IP: $TS_IP"

      - name: Verify XRDP is listening
        run: |
          set -eux

          sudo DEBIAN_FRONTEND=noninteractive apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y netcat-openbsd

          # Check locally first
          nc -zv 127.0.0.1 3389

      - name: Show connection details & keep VM alive
        run: |
          set -eux

          echo ""
          echo "=========== UBUNTU KDE RDP SESSION ==========="
          echo "Tailscale IP : $TAILSCALE_IP"
          echo "RDP Username : $RDP_USER"
          echo "RDP Password : $RDP_PASSWORD"
          echo "RDP Port     : 3389"
          echo "=============================================="
          echo ""
          echo "Use any RDP client (Windows App / Android / iOS"
          echo "Remote Desktop) and connect to:"
          echo "    ${TAILSCALE_IP}:3389"
          echo ""

          # keep the runner alive so you can actually use the desktop
          while true; do
            echo "[$(date)] KDE RDP session still running..."
            sleep 300
          done              Lower   = [char[]](97..122)     # a-z
              Number  = [char[]](48..57)      # 0-9
              Special = ([char[]](33..47) + [char[]](58..64) +
                         [char[]](91..96) + [char[]](123..126)) # Special characters
          }
          $rawPassword = @()
          $rawPassword += $charSet.Upper | Get-Random -Count 4
          $rawPassword += $charSet.Lower | Get-Random -Count 4
          $rawPassword += $charSet.Number | Get-Random -Count 4
          $rawPassword += $charSet.Special | Get-Random -Count 4
          $password = -join ($rawPassword | Sort-Object { Get-Random })
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"
          
          echo "RDP_CREDS=User: RDP | Password: $password" >> $env:GITHUB_ENV
          
          if (-not (Get-LocalUser -Name "RDP")) {
              Write-Error "User creation failed"
              exit 1
          }

      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force

      - name: Establish Tailscale Connection
        run: |
          # Bring up Tailscale with the provided auth key and set a unique hostname
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID
          
          # Wait for Tailscale to assign an IP
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 10) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              Start-Sleep -Seconds 5
              $retries++
          }
          
          if (-not $tsIP) {
              Write-Error "Tailscale IP not assigned. Exiting."
              exit 1
          }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
      
      - name: Verify RDP Accessibility
        run: |
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          
          # Test connectivity using Test-NetConnection against the Tailscale IP on port 3389
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389
          if (-not $testResult.TcpTestSucceeded) {
              Write-Error "TCP connection to RDP port 3389 failed"
              exit 1
          }
          Write-Host "TCP connectivity successful!"

      - name: Maintain Connection
        run: |
          Write-Host "`n=== RDP ACCESS ==="
          Write-Host "Address: $env:TAILSCALE_IP"
          Write-Host "Username: RDP"
          Write-Host "Password: $(echo $env:RDP_CREDS)"
          Write-Host "==================`n"
          
          # Keep runner active indefinitely (or until manually cancelled)
          while ($true) {
              Write-Host "[$(Get-Date)] RDP Active - Use Ctrl+C in workflow to terminate"
              Start-Sleep -Seconds 300
          }
